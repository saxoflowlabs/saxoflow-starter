name: SaxoFlow Full Test Suite

on:
  push:
    branches: [ "**" ]
  pull_request:
    branches: [ "**" ]

jobs:
  test:
    runs-on: ubuntu-latest

    strategy:
      matrix:
        python-version: [ "3.9", "3.10", "3.11" ]

    steps:
      - name: ğŸ“¥ Checkout repository
        uses: actions/checkout@v3

      - name: ğŸŸ© [Debug] After checkout
        run: echo "âœ… Checked out repository"

      - name: ğŸ Set up Python ${{ matrix.python-version }}
        uses: actions/setup-python@v4
        with:
          python-version: ${{ matrix.python-version }}

      - name: ğŸŸ© [Debug] After Python setup
        run: echo "âœ… Python ${{ matrix.python-version }} set up"

      - name: ğŸ›  Install EDA Tools and System Dependencies
        run: |
          echo "ğŸŸ© Installing system dependencies and EDA tools..."
          sudo apt-get update
          sudo apt-get install -y make git python3 python3-pip
          sudo apt-get install -y iverilog gtkwave openfpgaloader klayout magic netgen
          bash scripts/recipes/yosys.sh
          bash scripts/recipes/verilator.sh
          bash scripts/recipes/symbiyosys.sh
          bash scripts/recipes/nextpnr.sh
          bash scripts/recipes/openroad.sh
          # Add/remove as needed

      - name: ğŸŸ© [Debug] After EDA installs
        run: echo "âœ… EDA tools and system dependencies installed"

      - name: ğŸ§ª Python Environment + Editable Install
        run: |
          echo "ğŸŸ© Setting up Python environment and editable install..."
          python3 -m venv .venv
          source .venv/bin/activate
          pip install --upgrade pip
          pip install -e .
          pip install pytest flake8 coverage questionary rich

      - name: ğŸŸ© [Debug] After editable install
        run: echo "âœ… Python environment + editable install completed"

      - name: ğŸ§¹ Lint Python Code
        run: |
          echo "ğŸŸ© Running lint..."
          source .venv/bin/activate
          flake8 saxoflow/ saxoflow_agenticai/ --count --select=E9,F63,F7,F82 --show-source --statistics
          flake8 saxoflow/ saxoflow_agenticai/ --count --exit-zero --max-complexity=10 --max-line-length=127 --statistics

      - name: ğŸŸ© [Debug] After lint
        run: echo "âœ… Lint completed"

      - name: ğŸ§ª Run ALL Unit Tests
        run: |
          echo "ğŸŸ© Running unit tests..."
          source .venv/bin/activate
          pytest tests/ --tb=short -v --maxfail=3

      - name: ğŸŸ© [Debug] After unit tests
        run: echo "âœ… Unit tests completed"

      - name: ğŸ“Š Coverage Report (fail if <60%)
        run: |
          echo "ğŸŸ© Running coverage..."
          source .venv/bin/activate
          coverage run -m pytest tests/
          coverage report --fail-under=60 -m

      - name: ğŸŸ© [Debug] After coverage
        run: echo "âœ… Coverage report completed"
